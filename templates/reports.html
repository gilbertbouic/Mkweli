{% extends "base.html" %}

{% block title %}Reports - Mkweli AML{% endblock %}

{% block content %}
<div class="reports-header">
    <h1><i class="fas fa-chart-line"></i> Reports & Analytics</h1>
    <p>View screening history, analytics, and export compliance reports</p>
</div>

<!-- Date Range Filter -->
<div class="filter-section">
    <div class="filter-card">
        <h3><i class="fas fa-filter"></i> Date Range Filter</h3>
        <div class="filter-controls">
            <div class="filter-group">
                <label for="startDate">From:</label>
                <input type="date" id="startDate" class="form-control">
            </div>
            <div class="filter-group">
                <label for="endDate">To:</label>
                <input type="date" id="endDate" class="form-control">
            </div>
            <div class="filter-buttons">
                <button class="btn btn-primary btn-sm" onclick="applyDateFilter()">
                    <i class="fas fa-search"></i> Apply
                </button>
                <button class="btn btn-secondary btn-sm" onclick="clearDateFilter()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        <div class="quick-filters">
            <button class="btn btn-outline btn-sm" onclick="setQuickFilter('today')">Today</button>
            <button class="btn btn-outline btn-sm" onclick="setQuickFilter('week')">This Week</button>
            <button class="btn btn-outline btn-sm" onclick="setQuickFilter('month')">This Month</button>
            <button class="btn btn-outline btn-sm" onclick="setQuickFilter('year')">This Year</button>
        </div>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">
            <i class="fas fa-calendar-day"></i>
        </div>
        <div class="stat-content">
            <h3>Today's Screenings</h3>
            <div class="stat-number" id="todayScreenings">0</div>
            <div class="trend-indicator" id="todayTrend"></div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon monthly">
            <i class="fas fa-calendar-alt"></i>
        </div>
        <div class="stat-content">
            <h3>This Month</h3>
            <div class="stat-number" id="monthScreenings">0</div>
            <div class="trend-indicator" id="monthTrend"></div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon matches">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <div class="stat-content">
            <h3>Total Matches</h3>
            <div class="stat-number" id="totalMatches">0</div>
            <div class="match-rate" id="matchRate"></div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-icon total">
            <i class="fas fa-database"></i>
        </div>
        <div class="stat-content">
            <h3>Sanctions Entities</h3>
            <div class="stat-number" id="sanctionsCount">Loading...</div>
            <p class="stat-sub">In database</p>
        </div>
    </div>
</div>

<!-- Export Section -->
<div class="export-section">
    <div class="export-card">
        <h3><i class="fas fa-download"></i> Export Data</h3>
        <div class="export-buttons">
            <button class="btn btn-export" onclick="exportToCSV()">
                <i class="fas fa-file-csv"></i> Export to CSV
            </button>
            <button class="btn btn-export" onclick="exportAllToPDF()">
                <i class="fas fa-file-pdf"></i> Export Summary PDF
            </button>
        </div>
    </div>
</div>

<!-- Screening History Table -->
<div class="history-section">
    <div class="history-card">
        <div class="history-header">
            <h3><i class="fas fa-history"></i> Screening History</h3>
            <div class="history-controls">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search client names..." onkeyup="searchReports()">
                </div>
                <button class="btn btn-danger btn-sm" id="clearAllBtn">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>
        </div>
        <div class="table-container">
            <table class="reports-table" id="reportsTable">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('id')">
                            ID <i class="fas fa-sort" id="sortIconId"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('client_name')">
                            Client Name <i class="fas fa-sort" id="sortIconName"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('matches_found')">
                            Matches <i class="fas fa-sort" id="sortIconMatches"></i>
                        </th>
                        <th class="sortable" onclick="sortTable('screening_time')">
                            Date/Time <i class="fas fa-sort" id="sortIconDate"></i>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reportsTableBody">
                    <tr>
                        <td colspan="5" class="loading-row">
                            <i class="fas fa-spinner fa-spin"></i> Loading reports...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container">
            <div class="pagination-info" id="paginationInfo">Showing 0 reports</div>
            <div class="pagination-controls">
                <button class="btn btn-pagination" id="prevPage" disabled onclick="changePage(-1)">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button class="btn btn-pagination" id="nextPage" disabled onclick="changePage(1)">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.reports-header {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid var(--primary-green);
}

.reports-header h1 {
    color: var(--dark-green);
    font-weight: 700;
    margin-bottom: 10px;
}

.reports-header p {
    color: #666;
    font-size: 1.1em;
}

/* Filter Section */
.filter-section {
    margin-bottom: 30px;
}

.filter-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.filter-card h3 {
    color: var(--dark-green);
    margin-bottom: 15px;
    font-size: 1.1em;
}

.filter-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
    margin-bottom: 15px;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-size: 0.85em;
    font-weight: 600;
    color: #666;
}

.filter-group .form-control {
    padding: 8px 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.filter-buttons {
    display: flex;
    gap: 10px;
}

.quick-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-green);
    color: var(--primary-green);
    transition: all 0.3s ease;
}

.btn-outline:hover {
    background: var(--primary-green);
    color: white;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex;
    gap: 20px;
    align-items: center;
    transition: transform 0.3s ease;
    border-left: 4px solid var(--primary-green);
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5em;
    background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
    color: white;
}

.stat-icon.monthly {
    background: linear-gradient(135deg, #3498db, #2980b9);
}

.stat-icon.matches {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.stat-icon.total {
    background: linear-gradient(135deg, #9b59b6, #8e44ad);
}

.stat-content h3 {
    font-size: 0.9em;
    color: #666;
    margin-bottom: 5px;
}

.stat-number {
    font-size: 2em;
    font-weight: 700;
    color: var(--dark-green);
}

.trend-indicator {
    font-size: 0.85em;
    font-weight: 600;
}

.trend-up {
    color: #27ae60;
}

.trend-down {
    color: #e74c3c;
}

.trend-neutral {
    color: #7f8c8d;
}

.match-rate, .stat-sub {
    font-size: 0.85em;
    color: #666;
}

/* Export Section */
.export-section {
    margin-bottom: 30px;
}

.export-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.export-card h3 {
    color: var(--dark-green);
    margin-bottom: 15px;
    font-size: 1.1em;
}

.export-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.btn-export {
    background: linear-gradient(135deg, var(--dark-brown), #5d4037);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.btn-export:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* History Section */
.history-section {
    margin-bottom: 30px;
}

.history-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
}

.history-header {
    background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.history-header h3 {
    margin: 0;
    font-size: 1.2em;
}

.history-controls {
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    position: relative;
    display: flex;
    align-items: center;
}

.search-box i {
    position: absolute;
    left: 12px;
    color: #999;
}

.search-box input {
    padding: 8px 12px 8px 35px;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    width: 200px;
}

.search-box input:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
}

.table-container {
    overflow-x: auto;
}

.reports-table {
    width: 100%;
    border-collapse: collapse;
}

.reports-table th {
    background: #f8f9fa;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    border-bottom: 2px solid #eee;
}

.reports-table th.sortable {
    cursor: pointer;
    user-select: none;
}

.reports-table th.sortable:hover {
    background: #eee;
}

.reports-table td {
    padding: 15px;
    border-bottom: 1px solid #eee;
}

.reports-table tbody tr:hover {
    background: #f8f9fa;
}

.loading-row {
    text-align: center;
    color: #666;
    padding: 40px !important;
}

.empty-row {
    text-align: center;
    color: #999;
    padding: 40px !important;
}

.empty-row i {
    font-size: 3em;
    margin-bottom: 15px;
    display: block;
}

.match-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85em;
    font-weight: 600;
}

.match-badge.no-match {
    background: #d4edda;
    color: #155724;
}

.match-badge.has-match {
    background: #f8d7da;
    color: #721c24;
}

.btn-action {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85em;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-print {
    background: var(--primary-green);
    color: white;
}

.btn-print:hover {
    background: var(--dark-green);
}

/* Pagination */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-top: 1px solid #eee;
    flex-wrap: wrap;
    gap: 15px;
}

.pagination-info {
    color: #666;
    font-size: 0.9em;
}

.pagination-controls {
    display: flex;
    align-items: center;
    gap: 15px;
}

.btn-pagination {
    padding: 8px 16px;
    border-radius: 6px;
    border: 1px solid var(--primary-green);
    background: white;
    color: var(--primary-green);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-pagination:hover:not(:disabled) {
    background: var(--primary-green);
    color: white;
}

.btn-pagination:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.page-info {
    color: #666;
    font-weight: 500;
}

/* Buttons */
.btn {
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.btn-sm {
    padding: 8px 16px;
    font-size: 0.9em;
}

.btn-primary {
    background: var(--primary-green);
    color: white;
}

.btn-primary:hover {
    background: var(--dark-green);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-danger {
    background: #e74c3c;
    color: white;
}

.btn-danger:hover {
    background: #c0392b;
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .filter-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .history-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .search-box input {
        width: 100%;
    }
    
    .pagination-container {
        flex-direction: column;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
let currentPage = 1;
let totalPages = 1;
let currentSort = { field: 'screening_time', order: 'desc' };
let allReports = [];
let filteredReports = [];
let dateFilter = { start: null, end: null };

// Initialize date inputs with today's date as default end
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('endDate').value = today;
    loadReports();
    loadStats();
});

// Load reports from API
function loadReports(page = 1) {
    const tbody = document.getElementById('reportsTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="loading-row"><i class="fas fa-spinner fa-spin"></i> Loading reports...</td></tr>';
    
    fetch(`/api/reports/list?page=${page}&per_page=100`)
        .then(response => response.json())
        .then(data => {
            allReports = data.reports || [];
            applyFiltersAndSort();
        })
        .catch(error => {
            console.error('Error loading reports:', error);
            tbody.innerHTML = '<tr><td colspan="5" class="empty-row"><i class="fas fa-exclamation-circle"></i> Error loading reports. Please try again.</td></tr>';
        });
}

// Apply filters and sorting
function applyFiltersAndSort() {
    filteredReports = [...allReports];
    
    // Apply date filter
    if (dateFilter.start || dateFilter.end) {
        filteredReports = filteredReports.filter(report => {
            const reportDate = new Date(report.screening_time).toISOString().split('T')[0];
            if (dateFilter.start && reportDate < dateFilter.start) return false;
            if (dateFilter.end && reportDate > dateFilter.end) return false;
            return true;
        });
    }
    
    // Apply search filter
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    if (searchTerm) {
        filteredReports = filteredReports.filter(report => 
            report.client_name.toLowerCase().includes(searchTerm)
        );
    }
    
    // Apply sorting
    filteredReports.sort((a, b) => {
        let aVal = a[currentSort.field];
        let bVal = b[currentSort.field];
        
        if (currentSort.field === 'screening_time') {
            aVal = new Date(aVal);
            bVal = new Date(bVal);
        }
        
        if (currentSort.order === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
    
    renderReports();
}

// Render reports to table
function renderReports() {
    const tbody = document.getElementById('reportsTableBody');
    const perPage = 10;
    totalPages = Math.ceil(filteredReports.length / perPage) || 1;
    
    if (currentPage > totalPages) currentPage = totalPages;
    
    const start = (currentPage - 1) * perPage;
    const pageReports = filteredReports.slice(start, start + perPage);
    
    if (pageReports.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-row">
                    <i class="fas fa-clipboard-list"></i>
                    No screening reports found.<br>
                    <small>Perform a screening from the Dashboard to see results here.</small>
                </td>
            </tr>
        `;
    } else {
        tbody.innerHTML = pageReports.map(report => `
            <tr>
                <td>${report.id}</td>
                <td><strong>${escapeHtml(report.client_name)}</strong></td>
                <td>
                    <span class="match-badge ${report.matches_found > 0 ? 'has-match' : 'no-match'}">
                        ${report.matches_found} match${report.matches_found !== 1 ? 'es' : ''}
                    </span>
                </td>
                <td>${formatDate(report.screening_time)}</td>
                <td>
                    <button class="btn-action btn-print" onclick="printReport(${report.id})" title="Print Report">
                        <i class="fas fa-print"></i> Print
                    </button>
                </td>
            </tr>
        `).join('');
    }
    
    // Update pagination
    document.getElementById('paginationInfo').textContent = `Showing ${pageReports.length} of ${filteredReports.length} reports`;
    document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
    document.getElementById('prevPage').disabled = currentPage <= 1;
    document.getElementById('nextPage').disabled = currentPage >= totalPages;
}

// Load statistics
function loadStats() {
    // Daily stats
    fetch('/api/reports/daily-stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('todayScreenings').textContent = data.screenings || 0;
            // Trend calculation would need historical data
            document.getElementById('todayTrend').innerHTML = '<span class="trend-neutral">—</span>';
        });
    
    // Monthly stats
    fetch('/api/reports/monthly-stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('monthScreenings').textContent = data.screenings || 0;
            document.getElementById('totalMatches').textContent = data.matches || 0;
            
            // Calculate match rate
            if (data.screenings > 0) {
                const rate = ((data.matches / data.screenings) * 100).toFixed(1);
                document.getElementById('matchRate').textContent = `${rate}% match rate`;
            }
            
            document.getElementById('monthTrend').innerHTML = '<span class="trend-neutral">—</span>';
        });
    
    // Sanctions count
    fetch('/api/dashboard/sanctions-count')
        .then(response => response.json())
        .then(data => {
            document.getElementById('sanctionsCount').textContent = (data.count || 0).toLocaleString();
        })
        .catch(() => {
            document.getElementById('sanctionsCount').textContent = 'Error';
        });
}

// Sort table
function sortTable(field) {
    if (currentSort.field === field) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.field = field;
        currentSort.order = 'desc';
    }
    
    // Update sort icons
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    const iconId = 'sortIcon' + field.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join('');
    const icon = document.getElementById(iconId);
    if (icon) {
        icon.className = currentSort.order === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }
    
    applyFiltersAndSort();
}

// Search reports
function searchReports() {
    currentPage = 1;
    applyFiltersAndSort();
}

// Date filter functions
function applyDateFilter() {
    dateFilter.start = document.getElementById('startDate').value || null;
    dateFilter.end = document.getElementById('endDate').value || null;
    currentPage = 1;
    applyFiltersAndSort();
}

function clearDateFilter() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
    dateFilter = { start: null, end: null };
    currentPage = 1;
    applyFiltersAndSort();
}

function setQuickFilter(period) {
    const today = new Date();
    let startDate;
    
    switch(period) {
        case 'today':
            startDate = today;
            break;
        case 'week':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 7);
            break;
        case 'month':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            break;
        case 'year':
            startDate = new Date(today.getFullYear(), 0, 1);
            break;
    }
    
    document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('endDate').value = today.toISOString().split('T')[0];
    applyDateFilter();
}

// Pagination
function changePage(delta) {
    currentPage += delta;
    renderReports();
}

// Export functions
function exportToCSV() {
    if (filteredReports.length === 0) {
        alert('No reports to export.');
        return;
    }
    
    const headers = ['ID', 'Client Name', 'Matches Found', 'Screening Date', 'Report Hash'];
    const csvContent = [
        headers.join(','),
        ...filteredReports.map(r => [
            r.id,
            `"${r.client_name.replace(/"/g, '""')}"`,
            r.matches_found,
            `"${formatDate(r.screening_time)}"`,
            r.report_hash || ''
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `mkweli_screening_reports_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
}

function exportAllToPDF() {
    // Open a summary page that can be printed as PDF
    const summaryWindow = window.open('', '_blank');
    const totalMatches = filteredReports.reduce((sum, r) => sum + r.matches_found, 0);
    
    summaryWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Mkweli AML - Screening Summary Report</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto; }
                h1 { color: #2e8b57; border-bottom: 2px solid #2e8b57; padding-bottom: 10px; }
                .summary { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                th { background: #f1f1f1; }
                .print-btn { background: #2e8b57; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 6px; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <button class="print-btn no-print" onclick="window.print()">Print Report</button>
            <h1>Mkweli AML Screening Summary</h1>
            <p>Generated: ${new Date().toLocaleString()}</p>
            <div class="summary">
                <p><strong>Total Screenings:</strong> ${filteredReports.length}</p>
                <p><strong>Total Matches Found:</strong> ${totalMatches}</p>
                <p><strong>Match Rate:</strong> ${filteredReports.length > 0 ? ((totalMatches / filteredReports.length) * 100).toFixed(1) : 0}%</p>
            </div>
            <h2>Recent Screenings</h2>
            <table>
                <thead>
                    <tr><th>ID</th><th>Client Name</th><th>Matches</th><th>Date</th></tr>
                </thead>
                <tbody>
                    ${filteredReports.slice(0, 50).map(r => `
                        <tr>
                            <td>${r.id}</td>
                            <td>${escapeHtml(r.client_name)}</td>
                            <td>${r.matches_found}</td>
                            <td>${formatDate(r.screening_time)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            ${filteredReports.length > 50 ? '<p><em>Showing first 50 of ' + filteredReports.length + ' reports</em></p>' : ''}
        </body>
        </html>
    `);
}

// Print individual report
function printReport(reportId) {
    window.open(`/api/reports/export/${reportId}`, '_blank');
}

// Clear all reports
document.getElementById('clearAllBtn').addEventListener('click', function() {
    if (confirm('⚠️ WARNING: This will permanently delete ALL screening reports!\n\nAre you sure you want to continue?')) {
        if (confirm('This action CANNOT be undone. Click OK to confirm deletion.')) {
            fetch('/api/reports/clear-all?confirm=true', {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ ' + data.message);
                    loadReports();
                    loadStats();
                } else {
                    alert('❌ Error: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                alert('❌ Error clearing reports: ' + error);
            });
        }
    }
});

// Helper functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(isoString) {
    if (!isoString) return 'N/A';
    const date = new Date(isoString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
</script>
{% endblock %}
