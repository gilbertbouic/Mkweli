{% extends "base.html" %}

{% block content %}

<h1>Clients</h1>
<table class="table">
    <thead>
        <tr>
            <th>Name</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        {% for client in clients %}
        <tr>
            <td>{{ client.name }}</td>
            <td>{{ client.check_date }}</td>
            <td><a href="{{ url_for('report', client_id=client.id) }}">View Report</a> | <a href="{{ url_for('report_pdf', client_id=client.id) }}">PDF</a></td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<a href="{{ url_for('wizard_client') }}" class="btn btn-primary">Add Client</a>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Client Management</h1>
    <div>
        <a href="{{ url_for('clear_all_clients') }}" class="btn btn-danger me-2" 
           onclick="return confirm('Are you sure you want to delete ALL clients? This action cannot be undone.')">
            Clear All Clients
        </a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
            + Add New Client
        </button>
    </div>
</div>

<!-- Clients Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">All Clients</h5>
    </div>
    <div class="card-body">
        {% if clients %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Full Name</th>
                        <th>ID Number</th>
                        <th>Date of Birth</th>
                        <th>Risk Score</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for client in clients %}
                    <tr>
                        <td>{{ client['id'] }}</td>
                        <td>{{ client['full_name'] }}</td>
                        <td>{{ client['id_number'] or '-' }}</td>
                        <td>{{ client['date_of_birth'] or '-' }}</td>
                        <td id="risk-score-{{ client['id'] }}">
                            {% if client['risk_score'] > 0 %}
                                <span class="badge bg-danger">{{ client['risk_score'] }} Match</span>
                            {% else %}
                                <span class="badge bg-success">Clear</span>
                            {% endif %}
                        </td>
                        <td>{{ client['created_at'][:10] }}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary check-sanctions-btn" 
                                    data-client-id="{{ client['id'] }}"
                                    data-client-name="{{ client['full_name'] }}"
                                    onclick="checkSanctions({{ client['id'] }}, '{{ client['full_name'] }}')">
                                Check Sanctions
                            </button>
                            <form action="{{ url_for('delete_client', client_id=client['id']) }}" method="POST" style="display:inline;">
                                <button type="submit" class="btn btn-sm btn-outline-danger" 
                                        onclick="return confirm('Are you sure you want to delete this client?')">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <p class="text-muted">No clients found. Add your first client to get started.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Client</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="full_name" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="full_name" name="full_name" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_number" class="form-label">ID Number</label>
                        <input type="text" class="form-control" id="id_number" name="id_number">
                    </div>
                    <div class="mb-3">
                        <label for="date_of_birth" class="form-label">Date of Birth</label>
                        <input type="date" class="form-control" id="date_of_birth" name="date_of_birth">
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <input type="text" class="form-control" id="address" name="address">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Client</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Sanctions Check Result Modal -->
<div class="modal fade" id="sanctionsResultModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sanctionsResultTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="sanctionsResultContent">
                <!-- Results will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="refreshPageBtn" onclick="refreshPage()">Refresh Page</button>
                <a id="generateReportBtn" class="btn btn-success" href="#">Generate Report</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Function to check sanctions
function checkSanctions(clientId, clientName) {
    fetch(`/check_sanctions/${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(`Error: ${data.error}`);
                return;
            }
            displaySanctionsResult(data, clientName);
        })
        .catch(error => {
            alert('Error checking sanctions: ' + error);
        });
}

// Display results in modal
function displaySanctionsResult(data, clientName) {
    const modalTitle = document.getElementById('sanctionsResultTitle');
    const modalContent = document.getElementById('sanctionsResultContent');
    const reportBtn = document.getElementById('generateReportBtn');
    
    reportBtn.href = `/reports/${data.client_id}`;
    
    modalTitle.textContent = `Sanctions Check for ${clientName}`;
    
    let resultHTML = '';
    
    if (data.matches_found === 0) {
        resultHTML = `
            <div class="alert alert-success">
                <h5>‚úÖ No Matches Found</h5>
                <p>This client does not appear on any sanctions lists.</p>
            </div>
            <div class="mt-3">
                <div class="alert alert-info">
                    <small>üéâ Risk score updated to 0. Click "Refresh Page" to update the table.</small>
                </div>
            </div>
        `;
    } else {
        resultHTML = `
            <div class="alert alert-danger">
                <h5>‚ö†Ô∏è ${data.matches_found} Potential Matches Found</h5>
                <p>Please review these matches carefully.</p>
            </div>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Source</th>
                            <th>Other Info</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        data.matches.forEach(match => {
            resultHTML += `
                <tr>
                    <td>${match.full_name}</td>
                    <td><span class="badge bg-secondary">${match.source_list}</span></td>
                    <td>${match.other_info || '-'}</td>
                </tr>
            `;
        });
        
        resultHTML += `
                    </tbody>
                </table>
            </div>
            <div class="mt-3">
                <div class="alert alert-warning">
                    <small>‚ö†Ô∏è Risk score has been updated to ${data.matches_found}. Click "Refresh Page" to see the updated status in the table.</small>
                </div>
            </div>
        `;
    }
    
    modalContent.innerHTML = resultHTML;
    
    // Update the risk score in the table immediately
    updateRiskScoreInTable(data);
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('sanctionsResultModal'));
    modal.show();
}

// Update risk score in the table after sanctions check
function updateRiskScoreInTable(data) {
    const riskScoreCell = document.getElementById(`risk-score-${data.client_id}`);
    if (riskScoreCell) {
        if (data.matches_found > 0) {
            riskScoreCell.innerHTML = `<span class="badge bg-danger">${data.matches_found} Match</span>`;
        } else {
            riskScoreCell.innerHTML = `<span class="badge bg-success">Clear</span>`;
        }
        console.log(`Updated risk score for client ${data.client_id} to ${data.matches_found}`);
    } else {
        console.log(`Risk score cell not found for client ${data.client_id}`);
    }
}

// Refresh the page to show updated data
function refreshPage() {
    location.reload();
}

// Page load setup
document.addEventListener('DOMContentLoaded', function() {
    console.log('MkweliAML Clients page loaded');
});
</script>

{% endblock %}
